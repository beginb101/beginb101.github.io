---
layout: post
title: MySQL SQL 튜닝용어(2)
description: >
  2022-09-26-MySQL SQL 튜닝용어(2)
hide_description: false
category: dailydev
---

- Table of Contents
{:toc}

## 조인 연산방식 용어
다수의 테이블에서 필요한 데이터 끼리 결합할 때 조인(join) 방식을 사용한다. 조인은 동일한 열값 또는 키값을 기준으로 데이터를 논리적으로 연결한다. 조인의 종류에는 내부 조인(inner join), 왼쪽 외부 조인(left outer join), 오른쪽 외부 조인(right outer join), 전체 외부 조인(full outer join), 교차 조인(crossjoin), 자연 조인(natural join) 등이 있다.
다음은 예제로 사용할 테이블이다.

<br>학생 테이블 

| 학번 | 이름   | 성별 |  
|:--- | :--- | :--- | 
| 1 | 이순신 | 남 |
| 2 | 신사임당 | 여 |
| 3 | 유재석 | 남 |
| 4 | 강감찬 | 여 |

<br>지도교수 테이블 

| 학번 | 지도교수명 |  
|:--- | :--- |  
| 1 | 이황 |
| 2 | 새종대왕 | 
| 3 | 김유신 | 
| 99 | 이황 | 

## 내부 조인
내부 조인(inner join)은 교집합에 해당하는 방식이다.

![600x400](/assets/img/blog/SQL_INNER_JOIN.png)
<br>  내부 조인(inner join)
{:.figure}

학생 테이블과 지도교수 테이블에서 학번 열로 내부 조인 시 1,2,4의 학번이 출력 된다.

<br>SQL

```sql
SELECT  학생.학번, 학생.이름, 지도교수.교수명
  FROM  학생
  JOIN  지도교수
    ON  학생.학번 = 지도교수.학번
```
내부 조인을 명시적 조인으로 표현한 SQL문이다.  JOIN 절에 조인대상 테이블 ON 절에 조인할 비교조건을 작성한다.

<br>SQL

```sql
SELECT  학생.학번, 학생.이름, 지도교수.교수명
  FROM  학생, 지도교수
 WHERE  학생.학번 = 지도교수.학번
```
내부 조인을 암시적 조인으로 작성한 SQL문이다.

<br>결과

| 학번 | 이름   | 교수명 |  
|:--- | :--- | :--- | 
| 1 | 이순신 | 이황 |
| 2 | 신사임당 | 세종대왕 |
| 4 | 강감찬 | 김유신 |

## 왼쪽 외부 조인
왼쪽 외부 조인(left outer join)은 왼쪽 테이블(먼저 작성된 테이블) 기준으로 오른쪽 테이블(나중에 작성된 테이블)과 조인 시 조인 조건과 일치하지 않더라도 왼쪽 테이블의 결과는 최종 결과에 포함된다.

![600x400](/assets/img/blog/SQL_OUTER_JOIN.png)
<br>  외부 조인(outer join)
{:.figure}

<br>왼쪽 외부 조인 SQL

```sql
SELECT  학생.학번, 학생.이름, 지도교수.교수명
  FROM  학생, 지도교수
  LEFT  OUTER JOIN  지도교수
                ON  학생.학번 = 지도교수.학번
```

<br>결과
| 학번 | 이름   | 교수명 |  
|:--- | :--- | :--- | 
| 1 | 이순신 | 이황 |
| 2 | 신사임당 | 세종대왕 |
| 3 | 유재석 | NULL |
| 4 | 강감찬 | 김유신 |

## 오른쪽 외부 조인
오른쪽 외부 조인(right outer join)은 오른쪽 테이블(나중에 작성된 테이블) 기준으로 왼쪽 테이블(먼저 작성된 테이블)과 조인 하지만 조건과 일치하지 않더라도 오른쪽 테이블의 결과는 최종 결과에 포함된다.

<br>오른쪽 외부 조인 SQL

```sql
SELECT  학생.학번, 학생.이름, 지도교수.교수명
  FROM  학생, 지도교수
 RIGHT  OUTER JOIN  지도교수
                ON  학생.학번 = 지도교수.학번
```

<br>결과
| 학번 | 이름   | 교수명 |  
|:--- | :--- | :--- | 
| 1 | 이순신 | 이황 |
| 2 | 신사임당 | 세종대왕 |
| 3 | 유재석 | NULL |
| 99 | NULL | 이황 |

오른쪽 외부 조인과 왼쪽 외부 조인은 RIGHT LEFT와 테이블 순서만 바꾸면 되기 때문에 쉽게 변경할 수 있다. 사람은 인지적 특성상 왼쪽 -> 오른쪽을 정방향으로 인식하기 때문에 왼쪽 외부조인으로만 일관성 있는 SQL문을 작성하는 것이 유지보수, 관리측면에서 유리하다.

## 교차 조인
교차 조인(crossjoin)은 수학적 관점에서 봤을 때 데카르트 곱이라고하는 곱집합 개념이다. 즉 조인에 참여하는 테이블에서 발생할 수 있는 모든 조합을 찾아내어 반환한다. 학생 테이블과 지도교수를 교차조인하면 총 16개의 결과가 출력된다.

<br>교차 조인 SQL - 명시적

```sql
SELECT  학생.학번, 학생.이름, 
        지도교수.학번, 지도교수.교수명
  FROM  학생, 지도교수
 CROSS  JOIN  지도교수
```

<br>교차 조인 SQL - 암시적

```sql
SELECT  학생.학번, 학생.이름, 
        지도교수.학번, 지도교수.교수명
  FROM  학생, 지도교수
```

## 자연 조인
자연 조인(natural join)은 2개 테이블에 동일한 열명이 있을 때 조인 조건절을 따로 작성하지 않아도 자동으로 조인을 수행해주는 방식이다.
내부 조인과 동일한 결과가 출력된다.

<br>자연 조인 SQL

```sql
SELECT  학생.*, 지도교수.*
  FROM  학생
NATURAL JOIN 지도교수
```

<br>결과

| 학번 | 이름   | 성별 | 학번 |교수명 |  
|:--- | :--- | :--- | :--- | :--- | 
| 1 | 이순신 | 남 | 1 | 이황|
| 2 | 신사임당 | 여 | 2 |세종대왕 |
| 4 | 강감찬 | 남 | 4 | 김유신 |

만약 동일한 열명이 없을 경우 자연 조인은 교차 조인으로 수행된다.
즉 동일한 열명이 있을경우 내부 조인 없을경우 교차 조인으로 수행된다.

## 조인 알고리즘 용어
다수의 테이블에서 조인을 수행할 때는 우선순위를 정해야한다.
접근할 테이블을 내부적으로 순번을 정하고 차례로 다음 순번테이블에 전달해야한다. 이때 이 선후 관계에 따라 드라이빙 테이블과 드리븐 테이블로 구분한다.

## 드라이빙 테이블과 드리븐 테이블
SQL문 조인 에서 먼저 접근하는 테이블을 드라이빙테이블, 드라이빙테이블의 검색 결과를 통해 데이터를 검색하는 테이블이 드리븐 테이블이다. 즉 조건절의 조건이 수행되고 조인절이 실행되는 것이다. 그러므로 가능하면 적은 결과가 반환될 것으로 예상되는 드라이빙 테이블을 선정하고 조건절의 열이 인덱스로 설정되도록 구성해야 한다.

## 중첩 루프 조인
중첩 루프 조인(nested loop join)은 드라이빙 테이블의 데이터 1건당 드리븐 테이블을 반복해 검색하며 양쪽 테이블에 공통된 데이터를 출력한다.
만약 조건절에 열이 인덱스가 생성되어 있지 않다면 모든 데이터에 접근해야 하기때문에 성능이 떨어진다. 이때 열이 인덱스가 생성되어 있다면 모든 데이터에 접근하지 않고 결과를 출력할 수 있게 된다. 인덱스가 설정되어 있더라도 비고유 인덱스일 경우 랜덤 액세스가 발생한다. 따라서 랜덤 액세스를 줄일 수 있도록 데이터의 액세스 범위를 좁히는 방향으로 인덱스를 설계하고 조건절을 작성해야 한다. 비고유 인덱스가 아니고 클러스터형 인덱스 라면 조회 효율이 매우 높다. 기본 키는 클러스터형 인덱스이다.

## 블록 중첩 루프 조인
블록 중첩 루프 조인 (block nested loop join)은 인덱스가 없는 드리븐 테이블을 조회할때 비효율적인 검색을 효율성을 높이고자 탄생한 것이다.
드라이빙 테이블에 대해 조인 버퍼라는 개념을 도입하여 조인 성능의 향상을 꾀할 수 있다. 블록 중첩 루프 조인은 다음 순서로 실행된다.

- 드라이빙 테이블에서 해당하는 데이터를 검색한다.
- 검색된 데이터를 조인 버퍼에 가득 채워질때까지 적재한다.
- 이후 조인 버퍼와 드리븐테이블의 데이터를 비교한다.
- 다시 조인 버퍼와 데이터를 조인한다.

이 과정은 비상연락망 테이블의 테이블 풀 스캔을 줄이는 게 목적이다.

## 배치 키 액세스 조인
중첩 루프 조인 방식은 필연적으로 데이터 접근시 인덱스에 의한 랜덤 액세스가 발생하므로, 액세스할 데이터의 범위가 넓다면 비효율적이다.
이러한 랜덤 액세스의 단점을 해결하고자 접근할 데이터를 미리 예상하고 가져오는 데 착안한 조인 알고리즘을 배치 키 액세스 조인이라고 한다.

배치 키 액세스 조인은 블록 중첩 루프 조인에서 다중 범위 읽기를 사용한 것이다. 미리 예측한 데이터를 랜덤 버퍼에 담기 때문에 시퀀셜 액세스를 수행하는 방식이다.

## 해시 조인
해시 조인(hash join)은 MySQL 8.0.18 버전부터 지원되는 조인 방식이다.
해시 조인은 조인에 참여하는 각 테이블의 데이터를 내부적으로 해시값으로 만들어 내부 조인을 수행한다. 해시값으로 내부 조인을 수행한 결과는 조인 버퍼에 저장되므로 조인열의 인덱스를 필수로 요구하지 않아도 된다.


## 참고 문헌

[업무에 바로 쓰는 SQL 튜닝](http://www.yes24.com/Product/Goods/102382080)